<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Music</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #8a2be2; /* Blueviolet */
            --bg-dark: #0a0510;
            --ghost: #f8f8ff; /* Ghost white */
            --glass: rgba(138, 43, 226, 0.15);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg-dark); 
            color: var(--ghost); 
            font-family: 'Google Sans', sans-serif; 
            overflow-x: hidden; 
        }

        /* --- HEADER & NAVIGATION --- */
        .header { 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            background: rgba(10, 5, 16, 0.9); 
            backdrop-filter: blur(25px);
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-back-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--ghost);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 18px;
            transition: 0.2s;
        }
        .nav-back-btn:active { transform: scale(0.9); background: var(--primary); }

        .search-pill {
            background: rgba(255, 255, 255, 0.08); 
            flex: 1; 
            border-radius: 15px; 
            padding: 5px 15px; 
            display: flex; 
            align-items: center; 
            border: 1px solid var(--glass-border);
        }

        .search-pill input { 
            flex: 1; 
            background: none; 
            border: none; 
            color: white; 
            padding: 10px; 
            font-size: 16px; 
        }

        /* --- VOZ ESTILO MODAL --- */
        .voice-btn {
            color: var(--primary);
            margin: 0 10px;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        .voice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 9000;
            backdrop-filter: blur(10px);
        }

        .voice-card {
            width: 100%;
            max-width: 500px;
            background: #120a1d;
            border-radius: 30px 30px 0 0;
            padding: 40px 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
            animation: slideUp 0.4s ease;
        }

        .voice-waves {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            height: 60px;
            margin-bottom: 20px;
        }

        .wave {
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 10px;
            animation: wave-anim 1s ease-in-out infinite;
        }
        .wave:nth-child(2) { animation-delay: 0.1s; }
        .wave:nth-child(3) { animation-delay: 0.2s; }
        .wave:nth-child(4) { animation-delay: 0.3s; }

        @keyframes wave-anim {
            0%, 100% { height: 15px; opacity: 0.5; }
            50% { height: 45px; opacity: 1; }
        }

        /* --- GRID DE MÚSICAS --- */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
            padding-bottom: 100px;
        }

        .card { 
            background: var(--glass); 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid var(--glass-border); 
            transition: 0.3s; 
            cursor: pointer;
            animation: fadeIn 0.5s ease backwards;
        }

        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .card:active { transform: scale(0.96); }

        /* --- PLAYER MODAL --- */
        #player-modal { 
            position: fixed; 
            inset: 0; 
            display: none; 
            z-index: 5000; 
            background: var(--bg-dark); 
            flex-direction: column; 
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1); 
            will-change: transform;
        }

        #p-bg { 
            position: absolute; 
            inset: 0; 
            z-index: -1; 
            opacity: 0.5; 
            filter: blur(100px); 
            background-size: cover; 
            background-position: center; 
        }
        
        .modal-body { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(20px); 
        }

        .modal-nav { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 15px 10px; 
            margin-bottom: 5px;
        }

        .nav-btn { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            color: var(--ghost); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            cursor: pointer; 
        }

        .p-cover { 
            width: 280px; 
            height: 280px; 
            border-radius: 25px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            margin-bottom: 20px; 
            pointer-events: none;
        }
        
        .p-ui { width: 100%; max-width: 450px; margin: 15px 0; }
        
        .prog-bg { 
            width: 100%; 
            height: 6px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            cursor: pointer; 
            position: relative;
        }

        .prog-fill { 
            height: 100%; 
            background: var(--primary); 
            width: 0%; 
            border-radius: 10px; 
            box-shadow: 0 0 10px var(--primary); 
        }

        .main-ctrls { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 40px; 
            margin-top: 25px; 
        }

        .btn-play { 
            width: 75px; 
            height: 75px; 
            background: var(--ghost); 
            color: black; 
            border-radius: 50%; 
            border: none; 
            font-size: 28px; 
            cursor: pointer; 
        }

        /* --- TABS DO PLAYER --- */
        .tab-bar-container { width: 100%; max-width: 550px; margin: 30px 0 20px 0; }
        .tab-bar { display: flex; gap: 18px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .tab-btn { flex-shrink: 0; padding: 14px 28px; border-radius: 30px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.06); color: var(--ghost); white-space: nowrap; cursor: pointer; font-size: 14px; font-weight: 600; }
        .tab-btn.active { background: var(--primary); border-color: var(--primary); }

        .dynamic-content { width: 100%; max-width: 500px; min-height: 250px; padding-bottom: 40px; }
        .tab-pane { display: none; animation: fadeIn 0.4s ease; }
        .tab-pane.active { display: block; }

        /* --- SUBMODAIS --- */
        .submodal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            align-items: flex-end; 
            justify-content: center; 
            z-index: 7000; 
        }

        .submodal-content { 
            width: 100%; 
            max-width: 500px; 
            background: #120a1d; 
            border-radius: 30px 30px 0 0; 
            padding: 20px; 
            border: 1px solid var(--glass-border); 
            backdrop-filter: blur(25px); 
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            max-height: 85vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            will-change: transform;
        }

        .drag-handle { 
            width: 45px; 
            height: 5px; 
            background: var(--glass-border); 
            border-radius: 10px; 
            margin: 0 auto 20px; 
            flex-shrink: 0; 
        }

        /* --- SLIDER DE SUGESTÕES --- */
        .suggest-viewport { width: 100%; overflow: hidden; flex: 1; position: relative; }
        .suggest-slider { 
            display: flex; 
            width: 200%; 
            height: 100%; 
            transition: transform 0.5s cubic-bezier(0.2, 0, 0, 1); 
        }
        .suggest-page { width: 50%; height: 100%; overflow-y: auto; padding: 0 5px; }

        .top-tabbar-horizontal { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            background: rgba(255,255,255,0.05); 
            padding: 5px; 
            border-radius: 15px; 
        }
        .top-tab-btn { 
            flex: 1; padding: 12px; border-radius: 12px; border: none; background: none; 
            color: var(--ghost); font-size: 13px; font-weight: bold; cursor: pointer; 
        }
        .top-tab-btn.active { background: var(--primary); }

        .list-item { 
            display: flex; align-items: center; gap: 15px; padding: 12px; 
            border-radius: 15px; background: rgba(255,255,255,0.03); 
            margin-bottom: 10px; cursor: pointer; border: 1px solid transparent;
        }
        .list-item:active { background: var(--glass); border-color: var(--glass-border); }
        .list-item img { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; }

        /* --- SHARE --- */
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px; padding-bottom: 20px; }
        .share-option { display: flex; flex-direction: column; align-items: center; gap: 10px; text-decoration: none; color: var(--ghost); cursor: pointer; }
        .share-icon { width: 60px; height: 60px; border-radius: 50%; background: var(--glass); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid var(--glass-border); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="header">
        <a href="../More_options.html" class="nav-back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>

        <div class="search-pill">
            <input type="text" id="search-input" placeholder="O que vamos ouvir agora?">
            <i class="fas fa-microphone voice-btn" onclick="startVoiceSearch()"></i>
            <i class="fas fa-search" onclick="search()" style="color: var(--primary); cursor: pointer;"></i>
        </div>
    </header>

    <main class="grid" id="main-grid"></main>

    <div id="voice-overlay" class="voice-overlay" onclick="stopVoiceSearch()">
        <div class="voice-card" onclick="event.stopPropagation()">
            <div class="drag-handle"></div>
            <div class="voice-waves">
                <div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div>
            </div>
            <h3 id="voice-status" style="margin-bottom: 10px;">Ouvindo...</h3>
            <p id="voice-result" style="color: var(--primary); font-style: italic; min-height: 1.5em;"></p>
            <button onclick="stopVoiceSearch()" style="background: var(--glass); border: 1px solid var(--glass-border); color: var(--ghost); padding: 12px 30px; border-radius: 20px; margin-top: 20px;">Cancelar</button>
        </div>
    </div>

    <div id="player-modal">
        <div id="p-bg"></div>
        <div class="modal-body">
            <div class="modal-nav">
                <div class="nav-btn" onclick="toggleSuggest(true)"><i class="fas fa-wand-magic-sparkles"></i></div>
                <div class="nav-btn" style="border:none; background:none; font-size:26px;" onclick="closePlayer()"><i class="fas fa-chevron-down"></i></div>
                <div class="nav-btn" onclick="toggleShare(true)"><i class="fas fa-share-alt"></i></div>
            </div>
            
            <img id="p-img" class="p-cover">
            
            <div style="text-align: center;">
                <h2 id="p-title" style="margin:0; font-size: 24px; padding: 0 20px;">Título</h2>
                <p id="p-artist" style="color: var(--primary); font-weight:bold; margin:8px 0; font-size: 18px;">Artista</p>
            </div>

            <div class="p-ui">
                <div class="prog-bg" id="prog-bar"><div class="prog-fill" id="fill"></div></div>
                <div class="main-ctrls">
                    <i class="fas fa-step-backward" onclick="prev()" style="font-size:32px; cursor:pointer;"></i>
                    <button class="btn-play" onclick="togglePlay()" id="btn-p"><i class="fas fa-play"></i></button>
                    <i class="fas fa-step-forward" onclick="next()" style="font-size:32px; cursor:pointer;"></i>
                </div>
            </div>

            <div class="tab-bar-container">
                <div class="tab-bar">
                    <button class="tab-btn active" onclick="switchTab(event, 'tab-lyrics')">LETRAS</button>
                    <button class="tab-btn" onclick="switchTab(event, 'tab-platforms')">PLATAFORMAS</button>
                    <button class="tab-btn" onclick="switchTab(event, 'tab-info')">SOBRE</button>
                </div>
            </div>

            <div class="dynamic-content">
                <div id="tab-lyrics" class="tab-pane active"><div id="lyric-content" style="white-space: pre-line; text-align: center; line-height: 2; font-size: 19px;"></div></div>
                <div id="tab-platforms" class="tab-pane"><div id="platform-list"></div></div>
                <div id="tab-info" class="tab-pane"><div id="song-info-extra" style="background: rgba(255,255,255,0.06); padding: 25px; border-radius: 25px; font-size: 14px; line-height: 1.6;"></div></div>
            </div>
        </div>
    </div>

    <div id="share-submodal" class="submodal-overlay" onclick="toggleShare(false)">
        <div class="submodal-content" onclick="event.stopPropagation()">
            <div class="drag-handle"></div>
            <h3 style="text-align: center; margin: 0 0 20px 0;">Compartilhar</h3>
            <div class="share-grid" id="share-options-container"></div>
        </div>
    </div>

    <div id="suggest-submodal" class="submodal-overlay" onclick="toggleSuggest(false)">
        <div class="submodal-content" onclick="event.stopPropagation()">
            <div class="drag-handle"></div>
            <div class="top-tabbar-horizontal">
                <button class="top-tab-btn active" id="btn-page-0" onclick="goToPage(0)">All Mix</button>
                <button class="top-tab-btn" id="btn-page-1" onclick="goToPage(1)">Do Artista</button>
            </div>
            
            <div class="suggest-viewport">
                <div class="suggest-slider" id="suggest-slider">
                    <div class="suggest-page" id="list-all"></div>
                    <div class="suggest-page" id="list-artist"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        let trackList = [];
        let curIdx = 0;

        /* --- NOVO: LÓGICA DE VOZ --- */
        const recognition = 'webkitSpeechRecognition' in window ? new webkitSpeechRecognition() : null;
        if (recognition) {
            recognition.lang = 'pt-BR';
            recognition.interimResults = true;
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('voice-result').innerText = text;
                if(e.results[0].isFinal) processVoice(text);
            };
            recognition.onerror = () => { speak("Não entendi."); stopVoiceSearch(); };
        }

        function startVoiceSearch() {
            if(!recognition) return alert("Voz não suportada.");
            document.getElementById('voice-overlay').style.display = 'flex';
            document.getElementById('voice-result').innerText = "";
            recognition.start();
        }

        function stopVoiceSearch() {
            document.getElementById('voice-overlay').style.display = 'none';
            recognition.stop();
        }

        async function processVoice(text) {
            stopVoiceSearch();
            document.getElementById('search-input').value = text;
            await search(text);
            if(trackList.length > 0) {
                speak(`Encontrei ${trackList[0].trackName}. Abrindo.`);
                openPlayer(0);
            } else {
                speak("Nenhum resultado.");
            }
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'pt-BR';
            window.speechSynthesis.speak(u);
        }

        /* --- SISTEMA DE GESTOS ORIGINAIS --- */
        function initGestures() {
            const player = document.getElementById('player-modal');
            setupSwipe(player, player, 'down', closePlayer);

            const suggest = document.getElementById('suggest-submodal');
            const suggestContent = suggest.querySelector('.submodal-content');
            setupSwipe(suggest, suggestContent, 'down', () => toggleSuggest(false));
            setupSwipe(suggest, suggestContent, 'horizontal', (dir) => {
                if (dir === 'left') goToPage(1);
                else if (dir === 'right') goToPage(0);
            });

            const share = document.getElementById('share-submodal');
            setupSwipe(share, share.querySelector('.submodal-content'), 'down', () => toggleShare(false));
        }

        function setupSwipe(overlay, target, type, callback) {
            let sX = 0, sY = 0, cX = 0, cY = 0;
            
            target.addEventListener('touchstart', e => { 
                sX = e.touches[0].clientX; sY = e.touches[0].clientY; 
                target.style.transition = 'none'; 
            }, {passive:true});

            target.addEventListener('touchmove', e => { 
                cX = e.touches[0].clientX; cY = e.touches[0].clientY; 
                if (type === 'down' && (cY - sY) > 0) {
                    target.style.transform = `translateY(${cY - sY}px)`;
                }
            }, {passive:true});

            target.addEventListener('touchend', () => {
                target.style.transition = 'transform 0.4s cubic-bezier(0.2, 0, 0, 1)';
                if (type === 'down') {
                    if ((cY - sY) > 150) { 
                        callback(); 
                        setTimeout(() => target.style.transform = '', 400); 
                    } else {
                        target.style.transform = 'translateY(0)';
                    }
                } else if (type === 'horizontal') {
                    if (Math.abs(cX - sX) > 60 && Math.abs(cY - sY) < 100) {
                        callback((cX - sX) > 0 ? 'right' : 'left');
                    }
                }
                sX = sY = cX = cY = 0;
            });
        }

        function goToPage(index) {
            document.getElementById('suggest-slider').style.transform = `translateX(-${index * 50}%)`;
            document.querySelectorAll('.top-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-page-${index}`).classList.add('active');
        }

        async function search(q = '') {
            const query = q || document.getElementById('search-input').value || 'Pop';
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=30`);
                const data = await res.json();
                trackList = data.results;
                renderGrid();
                if(!q) checkUrlParam(); // Só checa URL se não for busca por voz
            } catch (e) { console.error("Erro na busca", e); }
        }

        function renderGrid() {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = trackList.map((t, i) => `
                <div class="card" onclick="openPlayer(${i})" style="animation-delay: ${i*0.05}s">
                    <img src="${t.artworkUrl100.replace('100x100', '400x400')}">
                    <div style="padding:12px; font-size:13px;">
                        <div style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.trackName}</div>
                        <div style="opacity:0.6; margin-top:3px;">${t.artistName}</div>
                    </div>
                </div>`).join('');
        }

        function openPlayer(i) {
            curIdx = i; const t = trackList[curIdx]; 
            const img = t.artworkUrl100.replace('100x100', '600x600');
            
            document.getElementById('p-img').src = img;
            document.getElementById('p-bg').style.backgroundImage = `url('${img}')`;
            document.getElementById('p-title').innerText = t.trackName;
            document.getElementById('p-artist').innerText = t.artistName;
            
            audio.src = t.previewUrl;
            document.getElementById('player-modal').style.display = 'flex';
            document.getElementById('player-modal').style.transform = 'translateY(0)';
            
            audio.play(); 
            document.getElementById('btn-p').innerHTML = '<i class="fas fa-pause"></i>';
            
            fetchLyrics(t.artistName, t.trackName); 
            renderPlatforms(t);
            
            document.getElementById('song-info-extra').innerHTML = `
                <b>Álbum:</b> ${t.collectionName}<br>
                <b>Gênero:</b> ${t.primaryGenreName}<br>
                <b>Lançamento:</b> ${new Date(t.releaseDate).toLocaleDateString()}
            `;
        }

        function closePlayer() {
            document.getElementById('player-modal').style.transform = 'translateY(100%)';
            setTimeout(() => { 
                document.getElementById('player-modal').style.display = 'none'; 
                audio.pause(); 
            }, 400);
        }

        function toggleSuggest(show) {
            const sub = document.getElementById('suggest-submodal');
            const content = sub.querySelector('.submodal-content');
            if(show) {
                sub.style.display = 'flex';
                setTimeout(() => content.style.transform = 'translateY(0)', 10);
                fetchSuggestData();
            } else {
                content.style.transform = 'translateY(100%)';
                setTimeout(() => sub.style.display = 'none', 300);
            }
        }

        async function fetchSuggestData() {
            const t = trackList[curIdx];
            if(!t) return;
            const [resAll, resArtist] = await Promise.all([
                fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(t.primaryGenreName)}&entity=song&limit=15`),
                fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(t.artistName)}&entity=song&limit=15`)
            ]);
            const [dAll, dArtist] = await Promise.all([resAll.json(), resArtist.json()]);
            
            document.getElementById('list-all').innerHTML = dAll.results.map(s => renderListItem(s)).join('');
            document.getElementById('list-artist').innerHTML = dArtist.results.map(s => renderListItem(s)).join('');
        }

        function renderListItem(s) {
            const sJson = JSON.stringify(s).replace(/"/g, '&quot;');
            return `
                <div class="list-item" onclick="playSuggested(${sJson})">
                    <img src="${s.artworkUrl100}">
                    <div style="flex:1; overflow:hidden;">
                        <div style="font-weight:bold; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s.trackName}</div>
                        <div style="opacity:0.6; font-size:12px;">${s.artistName}</div>
                    </div>
                    <i class="fas fa-play" style="color:var(--primary);"></i>
                </div>`;
        }

        function playSuggested(song) {
            trackList.push(song);
            toggleSuggest(false);
            openPlayer(trackList.length - 1);
        }

        function toggleShare(show) {
            const sub = document.getElementById('share-submodal');
            const content = sub.querySelector('.submodal-content');
            if(show) {
                sub.style.display = 'flex';
                setTimeout(() => content.style.transform = 'translateY(0)', 10);
                renderShare();
            } else {
                content.style.transform = 'translateY(100%)';
                setTimeout(() => sub.style.display = 'none', 300);
            }
        }

        function renderShare() {
            const t = trackList[curIdx];
            const url = `${window.location.origin}${window.location.pathname}?track=${t.trackId}`;
            const msg = `Ouça ${t.trackName} de ${t.artistName}: `;
            
            const opts = [
                {n:'WhatsApp', i:'fab fa-whatsapp', u:`https://wa.me/?text=${encodeURIComponent(msg + url)}`},
                {n:'Telegram', i:'fab fa-telegram', u:`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(msg)}`},
                {n:'Facebook', i:'fab fa-facebook', u:`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`},
                {n:'X / Twitter', i:'fab fa-x-twitter', u:`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(msg)}`},
                {n:'Instagram', i:'fab fa-instagram', u:`https://www.instagram.com/`},
                {n:'Copiar Link', i:'fas fa-link', u:'copy'}
            ];
            document.getElementById('share-options-container').innerHTML = opts.map(o => `
                <div class="share-option" onclick="${o.u==='copy' ? 'copyToClip(\''+url+'\')' : 'window.open(\''+o.u+'\', \'_blank\')'}">
                    <div class="share-icon"><i class="${o.i}"></i></div>
                    <span style="font-size:11px">${o.n}</span>
                </div>`).join('');
        }

        function copyToClip(text) {
            navigator.clipboard.writeText(text);
            alert('Link copiado!');
            toggleShare(false);
        }

        async function checkUrlParam() {
            const id = new URLSearchParams(window.location.search).get('track');
            if (id) {
                const r = await fetch(`https://itunes.apple.com/lookup?id=${id}`);
                const d = await r.json();
                if (d.results.length) { 
                    trackList.unshift(d.results[0]); 
                    renderGrid(); 
                    openPlayer(0); 
                    window.history.replaceState({}, '', window.location.pathname); 
                }
            }
        }

        function switchTab(e, id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(id).classList.add('active');
        }

        function renderPlatforms(t) {
            const q = encodeURIComponent(`${t.artistName} ${t.trackName}`);
            const srv = [
                {n:'Spotify', i:'fab fa-spotify', c:'#1DB954', u:`https://open.spotify.com/search/${q}`},
                {n:'YouTube Music', i:'fab fa-youtube', c:'#ff0000', u:`https://music.youtube.com/search?q=${q}`},
                {n:'Apple Music', i:'fab fa-apple', c:'#fff', u:t.trackViewUrl},
                {n:'Deezer', i:'fab fa-deezer', c:'#ff0091', u:`https://www.deezer.com/search/${q}`},
                {n:'Tidal', i:'fas fa-water', c:'#00ffff', u:`https://listen.tidal.com/search?q=${q}`}
            ];
            document.getElementById('platform-list').innerHTML = srv.map(s => `
                <a href="${s.u}" target="_blank" style="display:flex; align-items:center; background:rgba(255,255,255,0.05); margin-bottom:12px; padding:18px; border-radius:20px; text-decoration:none; color:white; border:1px solid var(--glass-border);">
                    <i class="${s.i}" style="font-size:22px; margin-right:15px; color:${s.c};"></i>
                    <span style="flex:1; font-weight:500;">${s.n}</span>
                    <i class="fas fa-external-link-alt" style="font-size:12px; opacity:0.5;"></i>
                </a>`).join('');
        }

        async function fetchLyrics(a, s) {
            const d = document.getElementById('lyric-content');
            d.innerText = "Carregando letra...";
            try {
                const r = await fetch(`https://api.vagalume.com.br/search.php?art=${encodeURIComponent(a)}&mus=${encodeURIComponent(s)}`);
                const data = await r.json();
                d.innerText = (data.mus && data.mus[0]) ? data.mus[0].text : "Letra não encontrada.";
            } catch { d.innerText = "Erro ao carregar letra."; }
        }

        function togglePlay() {
            if (audio.paused) {
                audio.play();
                document.getElementById('btn-p').innerHTML='<i class="fas fa-pause"></i>';
            } else {
                audio.pause();
                document.getElementById('btn-p').innerHTML='<i class="fas fa-play"></i>';
            }
        }

        function next() { if(curIdx < trackList.length-1) openPlayer(curIdx+1); }
        function prev() { if(curIdx > 0) openPlayer(curIdx-1); }

        audio.ontimeupdate = () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('fill').style.width = pct + '%';
        };

        document.getElementById('prog-bar').onclick = e => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        };

        document.getElementById('search-input').onkeypress = e => { if(e.key==='Enter') search(); };

        initGestures();
        search();
    </script>
</body>
</html>
