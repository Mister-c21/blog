<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anime Memory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #8a2be2; /* Blueviolet */
            --accent-glow: rgba(138, 43, 226, 0.6);
            --ghost: #f8f8ff; /* Ghost White */
            --glass: rgba(255, 255, 255, 0.08); /* Vidro semitransparente */
            --glass-border: rgba(255, 255, 255, 0.15);
            --bg-dark: #050505;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body, html {
            height: 100%; width: 100%;
            background-color: var(--bg-dark);
            color: var(--ghost);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            position: fixed;
        }

        #bg-blur {
            position: fixed; inset: 0;
            background-size: cover; background-position: center;
            filter: blur(80px) brightness(0.15);
            z-index: -1; transform: scale(1.1);
            transition: background-image 0.8s ease;
        }

        /* --- UI OVERLAYS --- */
        #voice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .voice-wave { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; animation: pulse 1.5s infinite; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 30px rgba(138, 43, 226, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0); } }

        #audio-controls { position: fixed; bottom: 20px; right: 20px; background: var(--glass); border: 1px solid var(--glass-border); padding: 10px 15px; border-radius: 50px; display: none; align-items: center; gap: 12px; backdrop-filter: blur(20px); z-index: 5000; }
        #audio-controls input[type="range"] { width: 70px; accent-color: var(--accent); cursor: pointer; }

        /* --- SELECTION MODAL --- */
        #selection-modal { position: fixed; inset: 0; background: rgba(5, 5, 5, 0.94); backdrop-filter: blur(30px); z-index: 1000; display: flex; flex-direction: column; overflow-y: scroll; scrollbar-width: none; }
        #selection-modal::-webkit-scrollbar { display: none; }

        .modal-nav { padding: 30px 5% 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; position: sticky; top: 0; background: var(--bg-dark); z-index: 100; }
        .logo-text { font-weight: 900; font-size: 1.4rem; background: linear-gradient(45deg, var(--ghost), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; text-transform: uppercase; }

        .search-container { 
            display: flex; align-items: center; 
            background: var(--glass); border: 1px solid var(--glass-border); 
            padding: 2px 10px; border-radius: 50px; 
            width: 95%; max-width: 500px; 
            backdrop-filter: blur(15px); 
        }

        .search-container input { background: transparent; border: none; color: var(--ghost); padding: 12px 5px; outline: none; flex: 1; text-align: center; font-family: 'Outfit'; font-size: 0.95rem; min-width: 0; }
        .search-container button, .search-container a { background: transparent; border: none; color: var(--accent); padding: 10px; cursor: pointer; font-size: 1.1rem; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .nav-divider { width: 1px; height: 20px; background: var(--glass-border); margin: 0 5px; }

        /* --- GRID DE CARDS --- */
        .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 0 6% 60px; }
        .card-item { aspect-ratio: 2/3; border-radius: 14px; overflow: hidden; border: 1px solid var(--glass-border); background: var(--glass); cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-item:hover { transform: scale(1.05); border-color: var(--accent); box-shadow: 0 12px 25px var(--accent-glow); z-index: 2; }
        .card-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- GAME CANVAS --- */
        .game-canvas { height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 92vw; max-width: 500px; justify-content: center; }
        
        .memory-card { position: relative; transform-style: preserve-3d; transition: transform 0.5s; cursor: pointer; width: 100%; }
        .memory-card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; border: 1px solid var(--glass-border); }
        .card-back { background: var(--glass); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent); }
        .card-front { background: white; transform: rotateY(180deg); }
        .card-front img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }

        .header-btns { position: absolute; top: 20px; width: 90%; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .btn-circle { background: var(--glass); border: 1px solid var(--glass-border); color: var(--ghost); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s; font-size: 1.1rem; }
        .btn-circle:hover { background: var(--accent); transform: scale(1.1); border-color: var(--accent); }
        
        .right-btns { display: flex; gap: 10px; }

        #timer-display { font-weight: 900; color: var(--accent); background: var(--glass); padding: 8px 20px; border-radius: 20px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px); letter-spacing: 1px; }
        #status-bar { margin-top: 25px; padding: 10px 25px; background: var(--accent); border-radius: 50px; font-weight: 900; font-size: 0.75rem; text-transform: uppercase; box-shadow: 0 4px 15px var(--accent-glow); text-align: center; }

        #difficulty-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .difficulty-card { background: var(--glass); border: 1px solid var(--glass-border); padding: 40px; border-radius: 30px; text-align: center; width: 85%; max-width: 400px; }
        .diff-btn { display: block; width: 100%; background: var(--glass); border: 1px solid var(--glass-border); color: var(--ghost); padding: 15px; margin: 10px 0; border-radius: 15px; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .diff-btn:hover { background: var(--accent); transform: scale(1.05); }
    </style>
</head>
<body>

<div id="bg-blur"></div>
<audio id="bg-music" loop></audio>

<div id="voice-overlay">
    <div class="voice-wave"><i class="fa-solid fa-microphone"></i></div>
    <p style="margin-top:20px; letter-spacing:2px">OUVINDO...</p>
</div>

<div id="audio-controls">
    <button onclick="toggleMusic()" id="music-toggle-btn" style="background:transparent; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-pause"></i></button>
    <input type="range" min="0" max="1" step="0.05" value="0.4" oninput="document.getElementById('bg-music').volume = this.value">
</div>

<div id="difficulty-menu">
    <div class="difficulty-card">
        <h2 style="letter-spacing: 2px;">TAMANHO DO JOGO</h2>
        <button class="diff-btn" onclick="selectGrid(3, 3)">PEQUENO (8 CARDS)</button>
        <button class="diff-btn" onclick="selectGrid(4, 3)">MÃ‰DIO (12 CARDS)</button>
        <button class="diff-btn" onclick="selectGrid(5, 3)">GRANDE (14 CARDS)</button>
        <button onclick="closeDiffMenu()" style="background:none; border:none; color:gray; margin-top:10px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<div id="selection-modal">
    <div class="modal-nav">
        <div class="logo-text">ANIME MEMORY</div>
        <div class="search-container">
            <a href="../../More_options.html"><i class="fa-solid fa-home"></i></a>
            <div class="nav-divider"></div>
            <button onclick="startVoiceSearch()"><i class="fa-solid fa-microphone"></i></button>
            <input type="text" id="userQuery" placeholder="Buscar..." autocomplete="off">
            <div class="nav-divider"></div>
            <button onclick="openDiffMenu('search')"><i class="fa-solid fa-play"></i></button>
        </div>
    </div>
    <div class="cards-grid" id="main-grid">
        <div class="card-item" onclick="openDiffMenu('random')">
            <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(135deg, #1a0033, var(--accent))">
                <span style="font-size: 2.2rem;">ðŸŽ²</span>
                <p style="font-size:0.6rem; font-weight:900; margin-top:8px">SURPRESA</p>
            </div>
        </div>
    </div>
</div>

<div class="game-canvas">
    <div class="header-btns">
        <div class="btn-circle" onclick="openSelection()"><i class="fa-solid fa-arrow-left"></i></div>
        <div id="timer-display">00:00</div>
        <div class="right-btns">
            <div class="btn-circle" onclick="shareGame()"><i class="fa-solid fa-share-nodes"></i></div>
            <div class="btn-circle" onclick="resetGame()"><i class="fa-solid fa-rotate-right"></i></div>
        </div>
    </div>
    <div id="memory-grid"></div>
    <div id="status-bar">SELECIONE UM TEMA</div>
</div>

<script>
    let rows = 3, cols = 3, flippedCards = [], matchedCount = 0, canFlip = true;
    let timerInterval = null, secondsElapsed = 0, pendingAction = null, currentTitle = "", lastThemeData = null, isGameOver = false;
    const audio = document.getElementById('bg-music');

    // --- COMPARTILHAMENTO INTELIGENTE (ESTILO PUZZLE) ---
    async function shareGame() {
        const timeStr = document.getElementById('timer-display').innerText;
        if(!lastThemeData) return;
        
        const data = btoa(encodeURIComponent(JSON.stringify({
            id: lastThemeData.animeId,
            t: lastThemeData.title,
            u: lastThemeData.thumb,
            r: rows,
            c: cols
        })));
        
        const shareLink = `${window.location.origin}${window.location.pathname}?m=${data}`;
        const shareData = {
            title: 'Desafio Anime Memory',
            text: isGameOver ? `Completei o jogo de ${currentTitle} em ${timeStr}! Consegue superar?` : `Te desafio no Jogo da MemÃ³ria de ${currentTitle}!`,
            url: shareLink
        };

        try {
            if (navigator.share) { await navigator.share(shareData); } 
            else { await navigator.clipboard.writeText(shareLink); alert("Link de desafio copiado!"); }
        } catch (err) {}
    }

    function checkSharedLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const m = urlParams.get('m');
        if (m) {
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(m)));
                rows = decoded.r || 3; cols = decoded.c || 3;
                fetchCharacters(decoded.id, decoded.t, decoded.u);
            } catch(e) { console.error("Link invÃ¡lido"); }
        }
    }

    async function initMenu() {
        const grid = document.getElementById('main-grid');
        try {
            const response = await fetch('https://api.jikan.moe/v4/seasons/now?limit=23');
            const result = await response.json();
            result.data.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'card-item';
                card.innerHTML = `<img src="${anime.images.jpg.large_image_url}">`;
                card.onclick = () => openDiffMenu('direct', anime.mal_id, anime.title, anime.images.jpg.large_image_url);
                grid.appendChild(card);
            });
        } catch(e) {}
    }

    function openSelection() { stopTimer(); document.getElementById('selection-modal').style.display='flex'; audio.pause(); document.getElementById('audio-controls').style.display = 'none'; }
    function openDiffMenu(type, id, title, img) { pendingAction = { type, id, title, img }; document.getElementById('difficulty-menu').style.display = 'flex'; }
    function closeDiffMenu() { document.getElementById('difficulty-menu').style.display = 'none'; }

    async function selectGrid(r, c) {
        rows = r; cols = c; closeDiffMenu();
        if(pendingAction.type === 'search') await loadSearch();
        else if(pendingAction.type === 'random') await loadRandom();
        else fetchCharacters(pendingAction.id, pendingAction.title, pendingAction.img);
    }

    async function loadSearch() {
        const q = document.getElementById('userQuery').value;
        const r = await fetch(`https://api.jikan.moe/v4/anime?q=${q}&limit=1`);
        const d = await r.json();
        if(d.data[0]) fetchCharacters(d.data[0].mal_id, d.data[0].title, d.data[0].images.jpg.large_image_url);
    }

    async function loadRandom() {
        const r = await fetch('https://api.jikan.moe/v4/random/anime');
        const d = await r.json();
        fetchCharacters(d.data.mal_id, d.data.title, d.data.images.jpg.large_image_url);
    }

    async function fetchCharacters(animeId, title, thumb) {
        audio.pause();
        currentTitle = title;
        lastThemeData = { animeId, title, thumb };
        document.getElementById('selection-modal').style.display = 'none';
        document.getElementById('bg-blur').style.backgroundImage = `url(${thumb})`;
        document.getElementById('status-bar').innerText = title;
        
        const r = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/characters`);
        const d = await r.json();
        
        let totalCards = rows * cols;
        if (totalCards % 2 !== 0) totalCards -= 1; 
        
        const neededPairs = totalCards / 2;
        let chars = d.data.slice(0, neededPairs).map(c => ({ id: c.character.mal_id, img: c.character.images.jpg.image_url }));
        let deck = [...chars, ...chars];

        playMusic(title);
        startGame(deck);
    }

    function playMusic(t) {
        fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(t + " opening theme")}&entity=song&limit=1`)
        .then(r => r.json()).then(d => { 
            if(d.results[0]) { 
                audio.src = d.results[0].previewUrl; 
                audio.play().catch(() => {});
                document.getElementById('audio-controls').style.display='flex'; 
                document.getElementById('music-toggle-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
            }
        });
    }

    function startGame(deck) {
        matchedCount = 0; flippedCards = []; canFlip = true; isGameOver = false;
        startTimer();
        deck.sort(() => Math.random() - 0.5);
        const grid = document.getElementById('memory-grid');
        grid.innerHTML = '';
        
        const gridRows = Math.ceil(deck.length / 3);
        const cardHeight = (65 / gridRows) + "vh";

        deck.forEach(data => {
            const card = document.createElement('div');
            card.className = 'memory-card';
            card.style.height = cardHeight;
            card.dataset.id = data.id;
            card.innerHTML = `<div class="card-face card-back"><i class="fa-solid fa-star"></i></div><div class="card-face card-front"><img src="${data.img}"></div>`;
            card.onclick = function() {
                if(!canFlip || this.classList.contains('flipped')) return;
                this.classList.add('flipped');
                flippedCards.push(this);
                if(flippedCards.length === 2) checkMatch(deck.length / 2);
            };
            grid.appendChild(card);
        });
    }

    function checkMatch(winTarget) {
        canFlip = false;
        const [c1, c2] = flippedCards;
        if(c1.dataset.id === c2.dataset.id) {
            matchedCount++; flippedCards = []; canFlip = true;
            if(matchedCount >= winTarget) { 
                stopTimer(); 
                isGameOver = true;
                document.getElementById('status-bar').innerText = "VITÃ“RIA!"; 
            }
        } else {
            setTimeout(() => { c1.classList.remove('flipped'); c2.classList.remove('flipped'); flippedCards = []; canFlip = true; }, 800);
        }
    }

    function resetGame() { if(lastThemeData) fetchCharacters(lastThemeData.animeId, lastThemeData.title, lastThemeData.thumb); }
    
    function startTimer() { 
        stopTimer();
        secondsElapsed = 0; 
        timerInterval = setInterval(() => { 
            secondsElapsed++; 
            const mins = Math.floor(secondsElapsed/60).toString().padStart(2,'0'); 
            const secs = (secondsElapsed%60).toString().padStart(2,'0'); 
            document.getElementById('timer-display').innerText = `${mins}:${secs}`; 
        }, 1000); 
    }
    
    function stopTimer() { clearInterval(timerInterval); }
    
    function toggleMusic() { 
        if (audio.paused) {
            audio.play();
            document.getElementById('music-toggle-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
        } else {
            audio.pause();
            document.getElementById('music-toggle-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
        }
    }

    function startVoiceSearch() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!Speech) return;
        const rec = new Speech();
        document.getElementById('voice-overlay').style.display='flex';
        rec.lang = 'pt-BR'; rec.start();
        rec.onresult = (e) => { 
            document.getElementById('userQuery').value = e.results[0][0].transcript; 
            document.getElementById('voice-overlay').style.display='none'; 
            openDiffMenu('search'); 
        };
        rec.onerror = () => document.getElementById('voice-overlay').style.display='none';
    }

    initMenu();
    checkSharedLink();
</script>
</body>
</html>
