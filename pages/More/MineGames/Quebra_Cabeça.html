<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anime Puzzle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #8a2be2; /* Blueviolet */
            --accent-glow: rgba(138, 43, 226, 0.6);
            --ghost: #f8f8ff; /* Ghost White */
            --glass: rgba(255, 255, 255, 0.08); /* Vidro semitransparente */
            --glass-border: rgba(255, 255, 255, 0.15);
            --bg-dark: #050505;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body, html {
            height: 100%; width: 100%;
            background-color: var(--bg-dark);
            color: var(--ghost);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            position: fixed;
        }

        #bg-blur {
            position: fixed; inset: 0;
            background-size: cover; background-position: center;
            filter: blur(80px) brightness(0.15);
            z-index: -1; transform: scale(1.1);
            transition: background-image 0.8s ease;
        }

        /* --- CONTROLES DE √ÅUDIO --- */
        #audio-controls {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 10px 15px; border-radius: 50px;
            display: none; align-items: center; gap: 12px;
            backdrop-filter: blur(20px); z-index: 5000;
        }
        #audio-controls input[type="range"] { width: 70px; accent-color: var(--accent); cursor: pointer; }

        /* --- SELECTION MODAL --- */
        #selection-modal {
            position: fixed; inset: 0;
            background: rgba(5, 5, 5, 0.94);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            z-index: 1000; display: flex; flex-direction: column;
            overflow-y: scroll; scrollbar-width: none;
        }
        #selection-modal::-webkit-scrollbar { display: none; }

        .modal-nav {
            padding: 30px 5% 20px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            position: sticky; top: 0; 
            background: linear-gradient(to bottom, var(--bg-dark) 90%, transparent);
            z-index: 100;
        }

        .logo-text {
            font-weight: 900; font-size: 1.4rem;
            background: linear-gradient(45deg, var(--ghost), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: 2px; text-transform: uppercase;
        }

        .search-container {
            display: flex; align-items: center;
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 2px 10px; border-radius: 50px;
            width: 95%; max-width: 500px;
            backdrop-filter: blur(15px);
        }

        .search-container input {
            background: transparent; border: none; color: var(--ghost);
            padding: 12px 5px; outline: none; flex: 1; min-width: 0;
            font-size: 0.95rem; font-family: 'Outfit', sans-serif; text-align: center;
        }

        .search-container button {
            background: transparent; border: none; cursor: pointer;
            padding: 10px; color: var(--accent); font-size: 1.1rem;
        }

        .nav-divider { width: 1px; height: 20px; background: var(--glass-border); }

        /* --- GRID DE CARDS --- */
        .section-row { margin: 10px 0 40px; width: 100%; }
        .cards-grid { 
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px;
            padding: 0 6% 60px;
        }

        .card-item { 
            aspect-ratio: 2/3; 
            border-radius: 14px; overflow: hidden; 
            cursor: pointer; border: 1px solid var(--glass-border); 
            background: var(--glass); position: relative;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-item:hover { transform: scale(1.05); border-color: var(--accent); box-shadow: 0 12px 25px var(--accent-glow); z-index: 2; }

        /* --- MENU DIFICULDADE --- */
        #difficulty-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .difficulty-card { background: var(--glass); border: 1px solid var(--glass-border); padding: 40px; border-radius: 30px; text-align: center; width: 85%; max-width: 400px; }
        .difficulty-options { display: flex; flex-direction: column; gap: 15px; margin-top: 25px; }
        .diff-btn { background: var(--glass); border: 1px solid var(--glass-border); color: var(--ghost); padding: 15px; border-radius: 15px; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .diff-btn:hover { background: var(--accent); transform: scale(1.05); }

        /* --- GAME CANVAS --- */
        .game-canvas { height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        #puzzle-grid { 
            display: grid; gap: 4px; width: 92vw; height: calc(92vw * 1.3); 
            max-width: 380px; max-height: 500px; 
        }
        
        @media (min-width: 1025px) {
            #puzzle-grid { max-width: 700px; max-height: 900px; width: 45vw; height: calc(45vw * 1.3); }
        }

        .tile { width: 100%; height: 100%; background-size: var(--sz) var(--sz); border-radius: 4px; border: 0.5px solid var(--glass-border); }
        .tile.empty { background: rgba(0,0,0,0.4) !important; border: 1px dashed var(--accent); }
        
        .header-btns { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; z-index: 100; }
        .btn-circle { 
            background: var(--glass); border: 1px solid var(--glass-border); 
            color: var(--ghost); width: 45px; height: 45px; 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; font-size: 1.2rem; 
            cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s;
        }
        .btn-circle:hover { background: var(--accent); border-color: var(--accent); transform: scale(1.1); }

        #timer-display {
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 8px 20px; border-radius: 20px;
            font-weight: 900; color: var(--accent); letter-spacing: 2px;
            backdrop-filter: blur(10px);
        }

        #status-bar { margin-top: 25px; padding: 10px 25px; background: var(--accent); border-radius: 50px; font-weight: 900; font-size: 0.75rem; text-transform: uppercase; }

        #voice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .voice-wave { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; animation: pulse 1.5s infinite; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0.6); } 70% { box-shadow: 0 0 0 30px rgba(138, 43, 226, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 43, 226, 0); } }
    </style>
</head>
<body>

<div id="bg-blur"></div>
<audio id="bg-music" loop></audio>

<div id="voice-overlay">
    <div class="voice-wave"><i class="fa-solid fa-microphone"></i></div>
    <p style="margin-top:20px; letter-spacing:2px">OUVINDO...</p>
</div>

<div id="audio-controls">
    <button onclick="toggleMusic()" id="music-toggle-btn" style="background:transparent; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-pause"></i></button>
    <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.4" oninput="adjustVolume(this.value)">
</div>

<div id="difficulty-menu">
    <div class="difficulty-card">
        <h2 style="letter-spacing: 2px;">DIFICULDADE</h2>
        <div class="difficulty-options">
            <button class="diff-btn" onclick="selectDifficulty(3)">3 X 3</button>
            <button class="diff-btn" onclick="selectDifficulty(6)">6 X 6</button>
            <button class="diff-btn" onclick="selectDifficulty(9)">9 X 9</button>
        </div>
        <button onclick="closeDiffMenu()" style="margin-top: 20px; background: transparent; border: none; color: gray; cursor: pointer;">Cancelar</button>
    </div>
</div>

<div id="selection-modal">
    <div class="modal-nav">
        <div class="logo-text">ANIME PUZZLE</div>
        <div class="search-container">
            <button onclick="window.location.href=window.location.pathname"><i class="fa-solid fa-home"></i></button>
            <div class="nav-divider"></div>
            <button onclick="startVoiceSearch()"><i class="fa-solid fa-microphone"></i></button>
            <input type="text" id="userQuery" placeholder="Buscar..." autocomplete="off">
            <div class="nav-divider"></div>
            <button onclick="openDiffMenu('search')"><i class="fa-solid fa-play"></i></button>
        </div>
    </div>

    <div class="section-row">
        <div class="cards-grid" id="main-grid">
            <div class="card-item" onclick="openDiffMenu('random')">
                <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background: linear-gradient(135deg, #1a0033, var(--accent))">
                    <span style="font-size: 2.2rem;">üé≤</span>
                    <p style="font-size:0.6rem; font-weight:900; margin-top:8px">SURPRESA</p>
                </div>
            </div>
            </div>
    </div>
</div>

<div class="game-canvas">
    <div class="header-btns">
        <div class="btn-circle" onclick="openSelection()"><i class="fa-solid fa-arrow-left"></i></div>
        <div id="timer-display">00:00</div>
        <div class="btn-circle" onclick="sharePuzzle()"><i class="fa-solid fa-share-nodes"></i></div>
    </div>
    <div id="puzzle-grid"></div>
    <div id="status-bar">Selecione um desafio</div>
</div>

<script>
    let gridSize = 3, currentOrder = [], emptyTileIndex = 0, currentImgUrl = "", currentTitle = "", isGameOver = false, pendingAction = null;
    let timerInterval = null, secondsElapsed = 0;
    const audio = document.getElementById('bg-music');

    // --- CRON√îMETRO ---
    function startTimer() { stopTimer(); secondsElapsed = 0; updateTimerDisplay(); timerInterval = setInterval(() => { secondsElapsed++; updateTimerDisplay(); }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function updateTimerDisplay() {
        const mins = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
        const secs = (secondsElapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${mins}:${secs}`;
    }

    // --- COMPARTILHAMENTO ---
    async function sharePuzzle() {
        const timeStr = document.getElementById('timer-display').innerText;
        const data = btoa(encodeURIComponent(JSON.stringify({t: currentTitle, u: currentImgUrl, s: gridSize})));
        const shareLink = `${window.location.origin}${window.location.pathname}?p=${data}`;
        const shareData = { title: 'Desafio Anime Puzzle', text: isGameOver ? `Fiz o puzzle de ${currentTitle} em ${timeStr}!` : `Te desafio a completa-lo em menos tempo ${currentTitle}!`, url: shareLink };
        try { if (navigator.share) { await navigator.share(shareData); } else { await navigator.clipboard.writeText(shareLink); alert("Link copiado!"); } } catch (err) {}
    }

    function checkSharedLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const p = urlParams.get('p');
        if (p) { try { const decoded = JSON.parse(decodeURIComponent(atob(p))); gridSize = decoded.s || 3; startGame(decoded.u, decoded.t); } catch(e) {} }
    }

    // --- BUSCA TEMPORADA ATUAL (SEASON NOW) ---
    async function initGrid() {
        const grid = document.getElementById('main-grid');
        try {
            const response = await fetch('https://api.jikan.moe/v4/seasons/now?limit=24');
            const result = await response.json();
            const animes = result.data;

            animes.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'card-item';
                const imgUrl = anime.images.jpg.large_image_url;
                const title = anime.title;
                
                card.innerHTML = `<img src="${imgUrl}" alt="${title}">`;
                card.onclick = () => openDiffMenu('direct', imgUrl, title);
                grid.appendChild(card);
            });
        } catch(e) { console.error("Erro ao carregar temporada atual", e); }
    }

    // --- CORE GAME ---
    async function playAnimeMusic(t) {
        try {
            const r = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(t + " anime theme")}&limit=1&media=music`);
            const d = await r.json();
            if (d.results[0]) { audio.src = d.results[0].previewUrl; audio.volume = 0.4; audio.play(); document.getElementById('audio-controls').style.display = 'flex'; }
        } catch (e) {}
    }

    function toggleMusic() {
        if (audio.paused) { audio.play(); document.getElementById('music-toggle-btn').innerHTML = '<i class="fa-solid fa-pause"></i>'; }
        else { audio.pause(); document.getElementById('music-toggle-btn').innerHTML = '<i class="fa-solid fa-play"></i>'; }
    }

    function openDiffMenu(type, url, title) { pendingAction = { type, url, title }; document.getElementById('difficulty-menu').style.display = 'flex'; }
    function closeDiffMenu() { document.getElementById('difficulty-menu').style.display = 'none'; }
    function openSelection() { stopTimer(); document.getElementById('selection-modal').style.display='flex'; audio.pause(); document.getElementById('audio-controls').style.display = 'none'; }

    async function selectDifficulty(size) {
        gridSize = size; closeDiffMenu();
        if(pendingAction.type === 'search') await loadGame();
        else if(pendingAction.type === 'random') await loadRandomAnime();
        else startGame(pendingAction.url, pendingAction.title);
    }

    function startGame(u, t) {
        isGameOver = false; currentImgUrl = u; currentTitle = t;
        document.getElementById('bg-blur').style.backgroundImage = `url(${u})`;
        document.getElementById('status-bar').innerText = t;
        document.getElementById('selection-modal').style.display='none';
        playAnimeMusic(t);
        startTimer();
        const total = gridSize * gridSize;
        currentOrder = Array.from({length: total}, (_, i) => i);
        for (let i = currentOrder.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [currentOrder[i], currentOrder[j]] = [currentOrder[j], currentOrder[i]]; }
        emptyTileIndex = currentOrder.indexOf(total - 1);
        renderBoard(u);
    }

    function renderBoard(u) {
        const g = document.getElementById('puzzle-grid'); g.innerHTML = '';
        g.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
        const szPercent = gridSize * 100;
        currentOrder.forEach((v, i) => {
            const t = document.createElement('div'); t.className = 'tile';
            t.style.setProperty('--sz', `${szPercent}%`);
            if (v === (gridSize * gridSize - 1) && !isGameOver) { t.classList.add('empty'); }
            else {
                t.style.backgroundImage = `url(${u})`;
                const row = Math.floor(v / gridSize), col = v % gridSize;
                t.style.backgroundPosition = `${(col / (gridSize - 1)) * 100}% ${(row / (gridSize - 1)) * 100}%`;
                if(!isGameOver) t.onclick = () => move(i);
            }
            g.appendChild(t);
        });
    }

    function move(i) {
        const r = Math.floor(i/gridSize), c = i%gridSize, er = Math.floor(emptyTileIndex/gridSize), ec = emptyTileIndex%gridSize;
        if (Math.abs(r-er) + Math.abs(c-ec) === 1) {
            [currentOrder[emptyTileIndex], currentOrder[i]] = [currentOrder[i], currentOrder[emptyTileIndex]];
            emptyTileIndex = i; renderBoard(currentImgUrl);
            if (currentOrder.every((v, k) => v === k)) { isGameOver = true; stopTimer(); document.getElementById('status-bar').innerText = "CONCLU√çDO!"; renderBoard(currentImgUrl); }
        }
    }

    function startVoiceSearch() {
        const rec = (window.SpeechRecognition || window.webkitSpeechRecognition) ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
        if(!rec) return;
        document.getElementById('voice-overlay').style.display='flex';
        rec.lang = 'pt-BR'; rec.start();
        rec.onresult = (e) => { document.getElementById('userQuery').value = e.results[0][0].transcript; document.getElementById('voice-overlay').style.display='none'; openDiffMenu('search'); };
    }

    async function loadGame() {
        const q = document.getElementById('userQuery').value;
        let r = await fetch(`https://api.jikan.moe/v4/anime?q=${q}&limit=1`);
        let d = await r.json(); if(d.data[0]) startGame(d.data[0].images.jpg.large_image_url, d.data[0].title);
    }
    
    async function loadRandomAnime() {
        let r = await fetch('https://api.jikan.moe/v4/random/anime');
        let d = await r.json(); startGame(d.data.images.jpg.large_image_url, d.data.title);
    }

    initGrid();
    checkSharedLink();
</script>
</body>
</html>
